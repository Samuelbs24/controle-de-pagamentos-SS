<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Pagamentos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 5px;
            text-align: center;
        }
        
        h1, h2, h3 {
            margin: 0;
        }
        
        .card {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        button, .btn {
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            margin-right: 5px;
        }
        
        .btn-primary {
            background-color: #3498db;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-success {
            background-color: #2ecc71;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-whatsapp {
            background-color: #25D366;
        }
        
        .btn-whatsapp:hover {
            background-color: #128C7E;
        }

        .btn-notificar {
            background-color: #25D366;
            color: white;
            padding: 12px 20px;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
        }

        .btn-notificar:hover {
            background-color: #128C7E;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            background: #eee;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        
        .tab.active {
            background: white;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .dashboard-card h3 {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .dashboard-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0 0;
            color: #2c3e50;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 5px;
            padding: 20px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            background: none;
            border: none;
        }

        .notificacao {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1001;
            display: none;
            max-width: 400px;
        }

        .notificacao.urgente {
            border-left: 4px solid #e74c3c;
            background: #ffecec;
        }

        .notificacao.proximo {
            border-left: 4px solid #f39c12;
            background: #fff8e6;
        }

        .notificacao.sucesso {
            border-left: 4px solid #2ecc71;
            background: #e8f8f0;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-pendente {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .status-pago {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .date-fields {
            display: flex;
            gap: 10px;
        }
        .date-fields .form-group {
            flex: 1;
        }

        /* Estilos para o sistema de login */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #2c3e50;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
        }
        
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: #eee;
            cursor: pointer;
        }
        
        .login-tab.active {
            background: white;
            font-weight: bold;
            border-bottom: 2px solid #3498db;
        }
        
        .login-form {
            display: none;
        }
        
        .login-form.active {
            display: block;
        }
        
        .user-info {
            background-color: #34495e;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .user-info button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .user-info button:hover {
            background-color: #c0392b;
        }

        /* Novos estilos para o painel de admin */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .admin-header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-card {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-ativo {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .status-inativo {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .status-pendente {
            color: #f39c12;
            font-weight: bold;
        }
        
        .licenca-expirando {
            background-color: #fff8e6;
        }
        
        .licenca-expirada {
            background-color: #ffecec;
        }

        /* Novos estilos para o painel de admin */
        .admin-card-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .admin-card-small {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        .admin-card-small h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .admin-card-small p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0 0;
            color: #3498db;
        }
        
        .ticket {
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3498db;
        }
        
        .ticket.urgente {
            border-left-color: #e74c3c;
        }
        
        .ticket.resolvido {
            border-left-color: #2ecc71;
        }
        
        .ticket-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .ticket-cliente {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .ticket-data {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .ticket-status {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-aberto {
            background-color: #f39c12;
            color: white;
        }
        
        .status-andamento {
            background-color: #3498db;
            color: white;
        }
        
        .status-resolvido {
            background-color: #2ecc71;
            color: white;
        }
        
        .ticket-mensagem {
            margin-top: 10px;
            color: #34495e;
        }
        
        .ticket-acoes {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .form-config-admin {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .senha-seguranca {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .senha-seguranca span {
            margin-left: 10px;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .senha-forte {
            color: #2ecc71 !important;
        }
        
        .senha-media {
            color: #f39c12 !important;
        }
        
        .senha-fraca {
            color: #e74c3c !important;
        }

        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }

        /* Novos estilos para a área de despesas */
        .categoria-pessoal {
            background-color: #e3f2fd;
        }
        
        .categoria-empresa {
            background-color: #e8f5e9;
        }
        
        .categoria-impostos {
            background-color: #fff3e0;
        }
        
        .categoria-outros {
            background-color: #f3e5f5;
        }
        
        .status-pendente {
            background-color: #fff3e0;
        }
        
        .status-pago {
            background-color: #e8f5e9;
        }
        
        .status-cancelado {
            background-color: #ffebee;
        }
        
        .badge-categoria {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .badge-pessoal {
            background-color: #bbdefb;
            color: #0d47a1;
        }
        
        .badge-empresa {
            background-color: #c8e6c9;
            color: #2e7d32;
        }
        
        .badge-impostos {
            background-color: #ffe0b2;
            color: #e65100;
        }
        
        .badge-outros {
            background-color: #e1bee7;
            color: #6a1b9a;
        }

        @media (max-width: 768px) {
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                margin-bottom: 5px;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }

            .date-fields {
                flex-direction: column;
                gap: 5px;
            }
            
            .login-box {
                padding: 20px;
            }

            .admin-card-section {
                grid-template-columns: 1fr;
            }

            .ticket-acoes {
                flex-direction: column;
            }
        }
    </style>

<!-- Firebase SDKs -->
<script type="module">
  // Import Firebase libraries
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, setDoc, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA8Ea-Enkjzp33IJCPHb86phcOT06nbygM",
    authDomain: "controle-pagamentos-81524.firebaseapp.com",
    projectId: "controle-pagamentos-81524",
    storageBucket: "controle-pagamentos-81524.firebasestorage.app",
    messagingSenderId: "599329294516",
    appId: "1:599329294516:web:331122bd11335cee1d6fe1",
    measurementId: "G-171SSMCWH8"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const analytics = getAnalytics(app);

  // Export for other scripts
  window.firebaseApp = app;
  window.firebaseDB = db;
  window.firebaseAuth = auth;
  window.firebaseFns = {
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    collection,
    getDocs,
    addDoc,
    setDoc,
    doc,
    updateDoc,
    deleteDoc,
    query,
    where
  };
</script>

</head>
<body>
    <!-- Página de Login -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <h2>Controle de Pagamentos</h2>
            
            <div class="login-tabs">
                <div class="login-tab active" onclick="openLoginTab('login')">Login</div>
                <div class="login-tab" onclick="openLoginTab('cadastro')">Cadastro</div>
            </div>
            
            <form id="login-form" class="login-form active">
                <div class="form-group">
                    <label for="login-email">E-mail</label>
                    <input type="email" id="login-email" required>
                </div>
                
                <div class="form-group">
                    <label for="login-senha">Senha</label>
                    <input type="password" id="login-senha" required>
                </div>
                
                <button type="button" class="btn-primary" style="width: 100%;" onclick="fazerLogin()">Entrar</button>
                
                <p style="text-align: center; margin-top: 15px; color: #7f8c8d;">
                    Use: demo@empresa.com / 123456
                </p>
            </form>
            
            <form id="cadastro-form" class="login-form">
                <div class="form-group">
                    <label for="cadastro-nome">Nome da Empresa</label>
                    <input type="text" id="cadastro-nome" required>
                </div>
                
                <div class="form-group">
                    <label for="cadastro-email">E-mail</label>
                    <input type="email" id="cadastro-email" required>
                </div>
                
                <div class="form-group">
                    <label for="cadastro-senha">Senha</label>
                    <input type="password" id="cadastro-senha" required>
                </div>
                
                <div class="form-group">
                    <label for="cadastro-confirmar-senha">Confirmar Senha</label>
                    <input type="password" id="cadastro-confirmar-senha" required>
                </div>
                
                <button type="button" class="btn-primary" style="width: 100%;" onclick="cadastrarEmpresa()">Cadastrar Empresa</button>
            </form>
        </div>
    </div>
    
    <!-- Sistema Principal -->
    <div id="app-container" class="container" style="display: none;">
        <div id="notificacao" class="notificacao" style="display: none;">
            <h3 id="notificacao-titulo">Lembrete de Pagamento</h3>
            <div id="notificacao-conteudo"></div>
            <div class="btn-group">
                <button class="btn-primary" onclick="fecharNotificacao()">Fechar</button>
                <button id="whatsapp-button" class="btn-whatsapp" style="display: none;">Enviar por WhatsApp</button>
            </div>
        </div>

        <div class="user-info">
            <span id="empresa-nome">Empresa</span>
            <div>
                <button onclick="gerenciarSessoes()" class="btn" style="margin-right: 10px;">Sessões Ativas</button>
                <button onclick="fazerLogout()">Sair</button>
            </div>
        </div>
        
        <header>
            <h1>Controle de Pagamentos</h1>
            <p>Sistema de gestão de folha de pagamento</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="openTab(event, 'dashboard')">Dashboard</div>
            <div class="tab" onclick="openTab(event, 'funcionarios')">Funcionários</div>
            <div class="tab" onclick="openTab(event, 'pagamentos')">Pagamentos</div>
            <div class="tab" onclick="openTab(event, 'despesas')">Despesas</div>
            <div class="tab" onclick="openTab(event, 'relatorios')">Relatórios</div>
            <div class="tab" onclick="openTab(event, 'diaristas')">Profissionais Diaristas</div>
        </div>
        
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <h3>Funcionários Ativos</h3>
                    <p id="total-funcionarios">0</p>
                </div>
                <div class="dashboard-card">
                    <h3>Folha deste mês</h3>
                    <p id="total-folha">R$ 0,00</p>
                </div>
                <div class="dashboard-card">
                    <h3>Próximo pagamento</h3>
                    <p id="proximo-pagamento">--/--/----</p>
                </div>
                <div class="dashboard-card">
                    <h3>Gastos com Profissionais</h3>
                    <p id="total-diaristas">R$ 0,00</p>
                </div>
                <div class="dashboard-card">
                    <h3>Total de Despesas</h3>
                    <p id="total-despesas-dashboard">R$ 0,00</p>
                </div>
            </div>
            
            <div class="card">
                <h2>Últimos Pagamentos</h2>
                <table id="ultimos-pagamentos">
                    <thead>
                        <tr>
                            <th>Funcionário/Profissional</th>
                            <th>Tipo</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="card">
                <h2>Últimas Despesas</h2>
                <table id="ultimas-despesas">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="funcionarios" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Funcionários</h2>
                    <button class="btn-primary" onclick="openModal('novo-funcionario')">+ Novo Funcionário</button>
                </div>
                
                <table id="tabela-funcionarios">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nome</th>
                            <th>Cargo</th>
                            <th>Salário</th>
                            <th>Dia Pagamento</th>
                            <th>Data Admissão</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="pagamentos" class="tab-content">
            <div class="card">
                <h2>Registrar Pagamento</h2>
                
                <div class="form-group">
                    <label for="funcionario-pagamento">Funcionário</label>
                    <select id="funcionario-pagamento" required>
                        <option value="">Selecione um funcionário</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Período do Pagamento</label>
                    <div class="date-fields">
                        <div class="form-group">
                            <label for="dia-pagamento">Dia</label>
                            <input type="number" id="dia-pagamento" min="1" max="31" required>
                        </div>
                        <div class="form-group">
                            <label for="mes-pagamento">Mês</label>
                            <select id="mes-pagamento" required>
                                <option value="">Selecione</option>
                                <option value="01">Janeiro</option>
                                <option value="02">Fevereiro</option>
                                <option value="03">Março</option>
                                <option value="04">Abril</option>
                                <option value="05">Maio</option>
                                <option value="06">Junho</option>
                                <option value="07">Julho</option>
                                <option value="08">Agosto</option>
                                <option value="09">Setembro</option>
                                <option value="10">Outubro</option>
                                <option value="11">Novembro</option>
                                <option value="12">Dezembro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ano-pagamento">Ano</label>
                            <input type="number" id="ano-pagamento" min="2000" max="2100" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="salario-base">Salário Base</label>
                    <input type="number" id="salario-base" step="0.01" readonly>
                </div>
                
                <div class="form-group">
                    <label for="horas-extras">Horas Extras</label>
                    <input type="number" id="horas-extras" value="0" min="0">
                </div>
                
                <div class="form-group">
                    <label for="descontos">Descontos</label>
                    <input type="number" id="descontos" value="0" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="bonus">Bônus</label>
                    <input type="number" id="bonus" value="0" min="0" step="0.01">
                </div>
                
                <div class="form-group">
                    <label for="total-pagamento">Total a Pagar</label>
                    <input type="number" id="total-pagamento" step="0.01" readonly>
                </div>
                
                <div class="btn-group">
                    <button class="btn-primary" onclick="calcularPagamento()">Calcular</button>
                    <button class="btn-success" onclick="registrarPagamento()">Registrar Pagamento</button>
                </div>
            </div>
            
            <div class="card">
                <h2>Histórico de Pagamentos</h2>
                <table id="historico-pagamentos">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Beneficiário</th>
                            <th>Tipo</th>
                            <th>Período</th>
                            <th>Valor</th>
                            <th>Data Pagamento</th>
                            <th>Status</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- Nova aba para Despesas -->
        <div id="despesas" class="tab-content">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Controle de Despesas</h2>
                    <button class="btn-primary" onclick="openModal('nova-despesa')">+ Nova Despesa</button>
                </div>
                
                <div class="form-group">
                    <label>Filtrar despesas:</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <select id="filtro-categoria" style="flex: 1;">
                            <option value="">Todas categorias</option>
                            <option value="Pessoal">Pessoal</option>
                            <option value="Empresa">Empresa</option>
                            <option value="Impostos">Impostos</option>
                            <option value="Outros">Outros</option>
                        </select>
                        
                        <select id="filtro-status" style="flex: 1;">
                            <option value="">Todos status</option>
                            <option value="Pago">Pago</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                        
                        <input type="month" id="filtro-mes-despesas" style="flex: 1;">
                        
                        <button class="btn-primary" onclick="filtrarDespesas()">Filtrar</button>
                        <button class="btn" onclick="limparFiltrosDespesas()">Limpar</button>
                    </div>
                </div>
                
                <table id="tabela-despesas">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Vencimento</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <div style="margin-top: 20px; font-weight: bold;">
                    Total de despesas: R$ <span id="total-despesas">0,00</span>
                </div>
            </div>
        </div>
        
        <div id="relatorios" class="tab-content">
            <div class="card">
                <h2>Relatórios</h2>
                
                <div class="form-group">
                    <label for="periodo-relatorio">Período</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="month" id="mes-inicio" required>
                        <span>até</span>
                        <input type="month" id="mes-fim" required>
                    </div>
                </div>
                
                <button class="btn-primary" onclick="gerarRelatorio()">Gerar Relatório</button>
                
                <div id="resultado-relatorio" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <!-- Aba de Profissionais Diaristas - Controle Financeiro -->
        <div id="diaristas" class="tab-content">
            <div class="card">
                <h2>Controle Financeiro de Profissionais Diaristas</h2>
                
                <div class="form-group">
                    <label>Filtrar por período:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="month" id="diaristas-mes-filtro">
                        <button class="btn-primary" onclick="filtrarDiaristasPorMes()">Filtrar</button>
                        <button class="btn" onclick="limparFiltroDiaristas()">Limpar</button>
                    </div>
                </div>
                
                <div class="card">
                    <h3>Registrar Pagamento a Profissional</h3>
                    
                    <div class="form-group">
                        <label for="diarista-nome-pagamento">Nome do(a) Profissional</label>
                        <input type="text" id="diarista-nome-pagamento" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="diarista-data-pagamento">Data do Serviço</label>
                        <input type="date" id="diarista-data-pagamento" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="diarista-valor-pagamento">Valor Pago (R$)</label>
                        <input type="number" id="diarista-valor-pagamento" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="diarista-descricao">Descrição do Serviço</label>
                        <input type="text" id="diarista-descricao">
                    </div>
                    
                    <button class="btn-success" onclick="registrarPagamentoDiarista()">Registrar Pagamento</button>
                </div>
                
                <div class="card">
                    <h3>Histórico de Pagamentos</h3>
                    <table id="tabela-pagamentos-diaristas">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Profissional</th>
                                <th>Valor</th>
                                <th>Descrição</th>
                                <th>Integrado na Folha</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Novo Painel de Administração (acessível via URL especial) -->
    <div id="admin-panel" class="admin-container" style="display: none;">
        <div class="admin-header">
            <h1>Painel de Controle - Administração</h1>
            <button onclick="fazerLogoutAdmin()" class="btn-danger">Sair</button>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="openAdminTab('licencas')">Licenciamento</div>
            <div class="tab" onclick="openAdminTab('clientes')">Clientes</div>
            <div class="tab" onclick="openAdminTab('suporte')">Suporte</div>
            <div class="tab" onclick="openAdminTab('config')">Configurações</div>
        </div>
        
        <div id="admin-licencas" class="admin-tab-content active">
            <div class="admin-card">
                <h2>Gerar Nova Licença</h2>
                
                <div class="form-group">
                    <label for="cliente-licenca">Cliente</label>
                    <select id="cliente-licenca" required>
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tipo-licenca">Tipo de Licença</label>
                    <select id="tipo-licenca" required>
                        <option value="30">30 dias (R$ <span id="preco-30">99,00</span>)</option>
                        <option value="90">90 dias (R$ <span id="preco-90">249,00</span>)</option>
                        <option value="180">180 dias (R$ <span id="preco-180">449,00</span>)</option>
                        <option value="365">1 ano (R$ <span id="preco-365">799,00</span>)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="data-inicio-licenca">Data de Início</label>
                    <input type="date" id="data-inicio-licenca" required>
                </div>
                
                <button class="btn-success" onclick="gerarLicenca()">Gerar Licença</button>
                
                <button class="btn-primary" style="margin-top: 15px;" onclick="openModal('editar-precos')">
                    Editar Preços das Licenças
                </button>
            </div>
            
            <div class="admin-card">
                <h2>Histórico de Licenças</h2>
                
                <div class="form-group">
                    <input type="month" id="filtro-mes-licencas">
                    <button class="btn-primary" onclick="filtrarLicencas()">Filtrar</button>
                    <button class="btn" onclick="limparFiltroLicencas()">Limpar</button>
                </div>
                
                <table id="tabela-licencas">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Tipo</th>
                            <th>Data Início</th>
                            <th>Data Fim</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="admin-clientes" class="admin-tab-content">
            <div class="admin-card">
                <h2>Clientes Cadastrados</h2>
                
                <div class="form-group">
                    <input type="text" id="filtro-clientes" placeholder="Filtrar por nome ou e-mail">
                    <button class="btn-primary" onclick="filtrarClientes()">Filtrar</button>
                </div>
                
                <table id="tabela-clientes">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Empresa</th>
                            <th>E-mail</th>
                            <th>Licença Ativa</th>
                            <th>Expira em</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <div id="admin-suporte" class="admin-tab-content">
            <div class="admin-card-section">
                <div class="admin-card-small">
                    <h3>Tickets Abertos</h3>
                    <p id="total-tickets-abertos">0</p>
                </div>
                <div class="admin-card-small">
                    <h3>Tickets Urgentes</h3>
                    <p id="total-tickets-urgentes">0</p>
                </div>
                <div class="admin-card-small">
                    <h3>Tickets Resolvidos</h3>
                    <p id="total-tickets-resolvidos">0</p>
                </div>
            </div>
            
            <div class="admin-card">
                <h2>Chamados de Suporte</h2>
                
                <div class="form-group">
                    <input type="text" id="filtro-tickets" placeholder="Filtrar por cliente ou assunto">
                    <button class="btn-primary" onclick="filtrarTickets()">Filtrar</button>
                    <button class="btn" onclick="limparFiltroTickets()">Limpar</button>
                </div>
                
                <div id="lista-tickets">
                    <!-- Tickets serão carregados aqui -->
                </div>
            </div>
        </div>
        
        <div id="admin-config" class="admin-tab-content">
            <div class="admin-card form-config-admin">
                <h2>Configurações do Administrador</h2>
                
                <div class="form-group">
                    <label for="admin-email">E-mail do Administrador</label>
                    <input type="email" id="admin-email" value="admin@controle.com">
                </div>
                
                <div class="form-group">
                    <label for="admin-senha-atual">Senha Atual</label>
                    <input type="password" id="admin-senha-atual" placeholder="Digite sua senha atual">
                </div>
                
                <div class="form-group">
                    <label for="admin-nova-senha">Nova Senha</label>
                    <input type="password" id="admin-nova-senha" placeholder="Digite a nova senha">
                    <div class="senha-seguranca">
                        <span id="forca-senha">Segurança da senha: </span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="admin-confirmar-senha">Confirmar Nova Senha</label>
                    <input type="password" id="admin-confirmar-senha" placeholder="Confirme a nova senha">
                </div>
                
                <button class="btn-success" onclick="atualizarCredenciaisAdmin()">Salvar Alterações</button>
            </div>
            
            <div class="admin-card">
                <h2>Acesso Remoto para Suporte</h2>
                <p>Use esta funcionalidade para acessar o sistema de um cliente e resolver problemas diretamente.</p>
                
                <div class="form-group">
                    <label for="cliente-acesso-remoto">Selecione o Cliente</label>
                    <select id="cliente-acesso-remoto">
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>
                
                <button class="btn-primary" onclick="iniciarAcessoRemoto()">Acessar como Cliente</button>
                <button class="btn-danger" onclick="finalizarAcessoRemoto()" style="display: none;" id="btn-finalizar-acesso">Finalizar Acesso Remoto</button>
                
                <div id="info-acesso-remoto" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; display: none;">
                    <p><strong>Acesso remoto ativo para:</strong> <span id="cliente-acesso-ativo"></span></p>
                    <p><strong>Tempo de sessão:</strong> <span id="tempo-sessao">00:00</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal para cadastro de novo funcionário -->
    <div id="novo-funcionario" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('novo-funcionario')">×</button>
            <h2>Novo Funcionário</h2>
            
            <div class="form-group">
                <label for="nome-funcionario">Nome Completo</label>
                <input type="text" id="nome-funcionario" required>
            </div>
            
            <div class="form-group">
                <label for="cpf-funcionario">CPF</label>
                <input type="text" id="cpf-funcionario" placeholder="000.000.000-00" required>
            </div>
            
            <div class="form-group">
                <label for="cargo-funcionario">Cargo</label>
                <input type="text" id="cargo-funcionario" required>
            </div>
            
            <div class="form-group">
                <label for="salario-funcionario">Salário Base</label>
                <input type="number" id="salario-funcionario" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="dia-pagamento-func">Dia do Pagamento (todo mês)</label>
                <input type="number" id="dia-pagamento-func" min="1" max="31" value="5" required>
            </div>
            
            <div class="form-group">
                <label for="data-admissao">Data de Admissão</label>
                <input type="date" id="data-admissao" required>
            </div>
            
            <div class="form-group">
                <label for="banco-funcionario">Banco</label>
                <input type="text" id="banco-funcionario">
            </div>
            
            <div class="form-group">
                <label for="conta-funcionario">Conta Bancária</label>
                <input type="text" id="conta-funcionario">
            </div>
            
            <button class="btn-primary" onclick="salvarFuncionario()">Salvar Funcionário</button>
        </div>
    </div>

    <!-- Modal para nova despesa -->
    <div id="nova-despesa" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('nova-despesa')">×</button>
            <h2>Nova Despesa</h2>
            
            <div class="form-group">
                <label for="despesa-descricao">Descrição</label>
                <input type="text" id="despesa-descricao" required>
            </div>
            
            <div class="form-group">
                <label for="despesa-categoria">Categoria</label>
                <select id="despesa-categoria" required>
                    <option value="Pessoal">Pessoal</option>
                    <option value="Empresa">Empresa</option>
                    <option value="Impostos">Impostos</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="despesa-valor">Valor (R$)</label>
                <input type="number" id="despesa-valor" step="0.01" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="despesa-data">Data</label>
                <input type="date" id="despesa-data" required>
            </div>
            
            <div class="form-group">
                <label for="despesa-vencimento">Vencimento (para despesas futuras)</label>
                <input type="date" id="despesa-vencimento">
            </div>
            
            <div class="form-group">
                <label for="despesa-status">Status</label>
                <select id="despesa-status" required>
                    <option value="Pago">Pago</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="despesa-observacoes">Observações</label>
                <textarea id="despesa-observacoes" rows="3"></textarea>
            </div>
            
            <button class="btn-primary" onclick="salvarDespesa()">Salvar Despesa</button>
        </div>
    </div>

    <!-- Modal para editar despesa -->
    <div id="editar-despesa" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('editar-despesa')">×</button>
            <h2>Editar Despesa</h2>
            
            <input type="hidden" id="editar-despesa-id">
            
            <div class="form-group">
                <label for="editar-despesa-descricao">Descrição</label>
                <input type="text" id="editar-despesa-descricao" required>
            </div>
            
            <div class="form-group">
                <label for="editar-despesa-categoria">Categoria</label>
                <select id="editar-despesa-categoria" required>
                    <option value="Pessoal">Pessoal</option>
                    <option value="Empresa">Empresa</option>
                    <option value="Impostos">Impostos</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editar-despesa-valor">Valor (R$)</label>
                <input type="number" id="editar-despesa-valor" step="0.01" min="0" required>
            </div>
            
            <div class="form-group">
                <label for="editar-despesa-data">Data</label>
                <input type="date" id="editar-despesa-data" required>
            </div>
            
            <div class="form-group">
                <label for="editar-despesa-vencimento">Vencimento</label>
                <input type="date" id="editar-despesa-vencimento">
            </div>
            
            <div class="form-group">
                <label for="editar-despesa-status">Status</label>
                <select id="editar-despesa-status" required>
                    <option value="Pago">Pago</option>
                    <option value="Pendente">Pendente</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="editar-despesa-observacoes">Observações</label>
                <textarea id="editar-despesa-observacoes" rows="3"></textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn-primary" onclick="atualizarDespesa()">Salvar Alterações</button>
                <button class="btn-danger" onclick="excluirDespesa()">Excluir Despesa</button>
            </div>
        </div>
    </div>

    <!-- Modal para editar preços -->
    <div id="editar-precos" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('editar-precos')">×</button>
            <h2>Editar Preços das Licenças</h2>
            
            <div class="form-group">
                <label for="preco-30-dias">Licença de 30 dias (R$)</label>
                <input type="number" id="preco-30-dias" step="0.01" min="0" value="99.00">
            </div>
            
            <div class="form-group">
                <label for="preco-90-dias">Licença de 90 dias (R$)</label>
                <input type="number" id="preco-90-dias" step="0.01" min="0" value="249.00">
            </div>
            
            <div class="form-group">
                <label for="preco-180-dias">Licença de 180 dias (R$)</label>
                <input type="number" id="preco-180-dias" step="0.01" min="0" value="449.00">
            </div>
            
            <div class="form-group">
                <label for="preco-365-dias">Licença de 1 ano (R$)</label>
                <input type="number" id="preco-365-dias" step="0.01" min="0" value="799.00">
            </div>
            
            <button class="btn-primary" onclick="salvarPrecosLicencas()">Salvar Preços</button>
        </div>
    </div>
    
    <!-- Modal para responder ticket -->
    <div id="responder-ticket" class="modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeModal('responder-ticket')">×</button>
            <h2>Responder Ticket de Suporte</h2>
            
            <div id="info-ticket" style="margin-bottom: 20px;">
                <p><strong>Cliente:</strong> <span id="ticket-cliente-nome"></span></p>
                <p><strong>Assunto:</strong> <span id="ticket-assunto"></span></p>
                <p><strong>Mensagem:</strong> <span id="ticket-mensagem-original"></span></p>
            </div>
            
            <div class="form-group">
                <label for="resposta-ticket">Sua Resposta</label>
                <textarea id="resposta-ticket" rows="5" style="width: 100%; padding: 10px;"></textarea>
            </div>
            
            <div class="form-group">
                <label for="status-ticket">Status do Ticket</label>
                <select id="status-ticket">
                    <option value="aberto">Aberto</option>
                    <option value="andamento">Em Andamento</option>
                    <option value="resolvido">Resolvido</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn-primary" onclick="enviarRespostaTicket()">Enviar Resposta</button>
                <button class="btn-danger" onclick="closeModal('responder-ticket')">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para gerenciar sessões -->
    <div id="gerenciar-sessoes" class="modal"></div>

    <script>
        // Dados das empresas e usuários
        let empresas = JSON.parse(localStorage.getItem('empresas')) || [
            {
                id: 1,
                nome: "Empresa Demo",
                email: "demo@empresa.com",
                senha: "123456",
                ativo: true,
                licencas: [
                    {
                        id: 1,
                        tipo: "365",
                        dataInicio: "2024-01-01",
                        dataFim: "2024-12-31",
                        valor: 799.00,
                        status: "ativo"
                    }
                ],
                funcionarios: [
                    { id: 1, nome: "João Silva", cpf: "123.456.789-00", cargo: "Desenvolvedor", salario: 5500.00, diaPagamento: 5, dataAdmissao: "2023-01-15", banco: "Banco do Brasil", conta: "12345-6" },
                    { id: 2, nome: "Maria Souza", cpf: "987.654.321-00", cargo: "Designer", salario: 4500.00, diaPagamento: 10, dataAdmissao: "2023-03-20", banco: "Itaú", conta: "54321-0" }
                ],
                pagamentos: [
                    { id: 1, funcionarioId: 1, funcionarioNome: "João Silva", tipo: "Funcionário", periodo: "05/06/2024", salarioBase: 5500.00, horasExtras: 5, descontos: 320.50, bonus: 500.00, total: 5679.50, dataPagamento: "2024-06-05", status: "Pago" },
                    { id: 2, funcionarioId: 2, funcionarioNome: "Maria Souza", tipo: "Funcionário", periodo: "10/06/2024", salarioBase: 4500.00, horasExtras: 2, descontos: 280.75, bonus: 0, total: 4219.25, dataPagamento: "2024-06-10", status: "Pago" }
                ],
                pagamentosDiaristas: [
                    { id: 1, nome: "Ana Souza", data: "2024-06-15", valor: 120.00, descricao: "Limpeza completa", integradoFolha: true },
                    { id: 2, nome: "Carlos Mendes", data: "2024-06-20", valor: 150.00, descricao: "Lavagem de roupas", integradoFolha: false }
                ],
                despesas: [
                    { id: 1, descricao: "Aluguel do escritório", categoria: "Empresa", valor: 2500.00, data: "2024-06-01", vencimento: null, status: "Pago", observacoes: "Pagamento mensal" },
                    { id: 2, descricao: "Material de escritório", categoria: "Empresa", valor: 350.50, data: "2024-06-10", vencimento: null, status: "Pago", observacoes: "" },
                    { id: 3, descricao: "Licença de software", categoria: "Empresa", valor: 1200.00, data: "2024-06-15", vencimento: "2024-07-15", status: "Pendente", observacoes: "Renovação anual" }
                ],
                tickets: [
                    {
                        id: 1,
                        assunto: "Problema ao registrar pagamento",
                        mensagem: "Não consigo registrar um novo pagamento, o sistema fica carregando e não conclui.",
                        data: "2024-06-10",
                        status: "resolvido",
                        resposta: "O problema foi resolvido atualizando o navegador para a versão mais recente.",
                        dataResposta: "2024-06-11",
                        urgente: false
                    }
                ]
            }
        ];
        
        // Variáveis globais para a empresa logada
        let empresaLogada = null;
        let funcionarios = [];
        let pagamentos = [];
        let pagamentosDiaristas = [];
        let despesas = [];
        
        // Variável para admin logado
        let adminLogado = false;

        // Sessões ativas
        let sessoesAtivas = JSON.parse(localStorage.getItem('sessoesAtivas')) || [];

        // Adicione estas novas variáveis
        let ticketsSuporte = JSON.parse(localStorage.getItem('ticketsSuporte')) || [];
        let precosLicencas = JSON.parse(localStorage.getItem('precosLicencas')) || {
            "30": 99.00,
            "90": 249.00,
            "180": 449.00,
            "365": 799.00
        };
        let credenciaisAdmin = JSON.parse(localStorage.getItem('credenciaisAdmin')) || {
            email: "admin@controle.com",
            senha: "admin123"
        };
        let acessoRemotoAtivo = null;
        let tempoAcessoRemoto = 0;
        let intervaloAcessoRemoto = null;

        // Funções de login e cadastro
        function openLoginTab(tabId) {
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.login-form').forEach(form => {
                form.classList.remove('active');
            });
            
            document.querySelector(`.login-tab[onclick="openLoginTab('${tabId}')"]`).classList.add('active');
            document.getElementById(`${tabId}-form`).classList.add('active');
        }

        function fazerLogin() {
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            
            if (!email || !senha) {
                alert('Preencha todos os campos');
                return;
            }
            
            // Verifica se é acesso de admin
            if (email === credenciaisAdmin.email && senha === credenciaisAdmin.senha) {
                acessarPainelAdmin();
                return;
            }
            
            const empresa = empresas.find(e => e.email === email && e.senha === senha);
            
            if (empresa) {
                // Verifica se a conta está ativa
                if (!empresa.ativo) {
                    alert('Esta conta está desativada. Entre em contato com o suporte.');
                    return;
                }
                
                // Verifica licença válida
                const licencaAtiva = empresa.licencas?.find(l => l.status === "ativo");
                if (!licencaAtiva) {
                    alert('Nenhuma licença ativa encontrada. Entre em contato com o suporte.');
                    return;
                }
                
                const hoje = new Date();
                const dataFim = new Date(licencaAtiva.dataFim);
                
                if (dataFim < hoje) {
                    alert('Sua licença expirou. Renove para continuar usando o sistema.');
                    return;
                }
                
                empresaLogada = empresa;
                
                // Cria nova sessão
                const novaSessao = {
                    id: Date.now(),
                    empresaId: empresa.id,
                    dispositivo: navigator.userAgent,
                    dataInicio: new Date().toISOString(),
                    ultimaAtividade: new Date().toISOString(),
                    ativa: true
                };
                
                sessoesAtivas.push(novaSessao);
                localStorage.setItem('sessoesAtivas', JSON.stringify(sessoesAtivas));
                
                iniciarSessao(empresa);
                
                // Salva a sessão no localStorage do dispositivo
                localStorage.setItem('sessao', JSON.stringify({ 
                    sessaoId: novaSessao.id,
                    empresaId: empresa.id,
                    licencaValida: true
                }));
            } else {
                alert('E-mail ou senha incorretos');
            }
        }

        function verificarSessoesAtivas() {
            const sessaoLocal = JSON.parse(localStorage.getItem('sessao'));
            if (sessaoLocal) {
                const sessao = sessoesAtivas.find(s => s.id === sessaoLocal.sessaoId && s.ativa);
                if (!sessao) {
                    // Sessão foi encerrada em outro dispositivo
                    fazerLogout();
                    alert('Sua sessão foi encerrada em outro dispositivo.');
                    return false;
                }
                
                // Atualiza última atividade
                sessao.ultimaAtividade = new Date().toISOString();
                localStorage.setItem('sessoesAtivas', JSON.stringify(sessoesAtivas));
                return true;
            }
            return false;
        }

        function gerenciarSessoes() {
            const modalContent = `
                <div class="modal-content" style="max-width: 800px;">
                    <button class="close-modal" onclick="closeModal('gerenciar-sessoes')">×</button>
                    <h2>Sessões Ativas</h2>
                    <p>Aqui você pode ver e gerenciar todos os dispositivos conectados à sua conta.</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Dispositivo</th>
                                <th>Data de Login</th>
                                <th>Última Atividade</th>
                                <th>Status</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="lista-sessoes">
                        </tbody>
                    </table>
                </div>
            `;
            
            const modal = document.getElementById('gerenciar-sessoes') || criarModal('gerenciar-sessoes');
            modal.innerHTML = modalContent;
            
            const sessoesEmpresa = sessoesAtivas.filter(s => s.empresaId === empresaLogada.id);
            const tbody = document.getElementById('lista-sessoes');
            tbody.innerHTML = '';
            
            sessoesEmpresa.forEach(sessao => {
                const tr = document.createElement('tr');
                const isCurrent = JSON.parse(localStorage.getItem('sessao'))?.sessaoId === sessao.id;
                
                tr.innerHTML = `
                    <td>${sessao.dispositivo} ${isCurrent ? '(Este dispositivo)' : ''}</td>
                    <td>${new Date(sessao.dataInicio).toLocaleString('pt-BR')}</td>
                    <td>${new Date(sessao.ultimaAtividade).toLocaleString('pt-BR')}</td>
                    <td>${sessao.ativa ? 'Ativa' : 'Encerrada'}</td>
                    <td>
                        ${!isCurrent && sessao.ativa ? 
                            `<button class="btn-danger btn-sm" onclick="encerrarSessaoRemota(${sessao.id})">Encerrar</button>` : 
                            '---'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            openModal('gerenciar-sessoes');
        }

        function encerrarSessaoRemota(sessaoId) {
            if (confirm('Deseja realmente encerrar esta sessão?')) {
                const sessaoIndex = sessoesAtivas.findIndex(s => s.id === sessaoId);
                if (sessaoIndex !== -1) {
                    sessoesAtivas[sessaoIndex].ativa = false;
                    sessoesAtivas[sessaoIndex].dataFim = new Date().toISOString();
                    localStorage.setItem('sessoesAtivas', JSON.stringify(sessoesAtivas));
                    gerenciarSessoes();
                    alert('Sessão encerrada com sucesso.');
                }
            }
        }

        function criarModal(id) {
            const modal = document.createElement('div');
            modal.id = id;
            modal.className = 'modal';
            document.body.appendChild(modal);
            return modal;
        }

        function cadastrarEmpresa() {
            const nome = document.getElementById('cadastro-nome').value;
            const email = document.getElementById('cadastro-email').value;
            const senha = document.getElementById('cadastro-senha').value;
            const confirmarSenha = document.getElementById('cadastro-confirmar-senha').value;
            
            if (!nome || !email || !senha || !confirmarSenha) {
                alert('Preencha todos os campos');
                return;
            }
            
            if (senha !== confirmarSenha) {
                alert('As senhas não coincidem');
                return;
            }
            
            if (empresas.some(e => e.email === email)) {
                alert('Já existe uma empresa cadastrada com este e-mail');
                return;
            }
            
            const novaEmpresa = {
                id: empresas.length > 0 ? Math.max(...empresas.map(e => e.id)) + 1 : 1,
                nome,
                email,
                senha,
                ativo: false, // Nova empresa começa como inativa até ter uma licença
                licencas: [],
                funcionarios: [],
                pagamentos: [],
                pagamentosDiaristas: [],
                despesas: [],
                tickets: []
            };
            
            empresas.push(novaEmpresa);
            localStorage.setItem('empresas', JSON.stringify(empresas));
            
            alert('Empresa cadastrada com sucesso! Entre em contato com o administrador para ativar sua conta.');
            openLoginTab('login');
            
            // Limpar formulário
            document.getElementById('cadastro-form').reset();
        }

        function iniciarSessao(empresa) {
            // Esconde a página de login e mostra o sistema
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            
            // Atualiza o nome da empresa no cabeçalho
            document.getElementById('empresa-nome').textContent = empresa.nome;
            
            // Carrega os dados da empresa nas variáveis globais
            funcionarios = empresa.funcionarios || [];
            pagamentos = empresa.pagamentos || [];
            pagamentosDiaristas = empresa.pagamentosDiaristas || [];
            despesas = empresa.despesas || [];
            
            // Atualiza as tabelas
            atualizarTabelas();
            atualizarTabelaDiaristas();
            carregarDespesas();
            verificarPagamentosPendentes();
        }

        function fazerLogout() {
            if (empresaLogada) {
                // Salva os dados da empresa antes de sair
                empresaLogada.funcionarios = funcionarios;
                empresaLogada.pagamentos = pagamentos;
                empresaLogada.pagamentosDiaristas = pagamentosDiaristas;
                empresaLogada.despesas = despesas;
                
                // Atualiza no localStorage
                const index = empresas.findIndex(e => e.id === empresaLogada.id);
                if (index !== -1) {
                    empresas[index] = empresaLogada;
                    localStorage.setItem('empresas', JSON.stringify(empresas));
                }
                
                // Encerra a sessão
                const sessaoLocal = JSON.parse(localStorage.getItem('sessao'));
                if (sessaoLocal) {
                    const sessaoIndex = sessoesAtivas.findIndex(s => s.id === sessaoLocal.sessaoId);
                    if (sessaoIndex !== -1) {
                        sessoesAtivas[sessaoIndex].ativa = false;
                        sessoesAtivas[sessaoIndex].dataFim = new Date().toISOString();
                        localStorage.setItem('sessoesAtivas', JSON.stringify(sessoesAtivas));
                    }
                }
            }
            
            // Limpa a sessão local
            empresaLogada = null;
            localStorage.removeItem('sessao');
            
            // Mostra a página de login e esconde o sistema
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            
            // Limpa os campos de login
            document.getElementById('login-form').reset();
        }

        // Funções de administração
        function acessarPainelAdmin() {
            const senhaAdmin = prompt("Digite a senha de administrador:");
            if (senhaAdmin === credenciaisAdmin.senha) {
                adminLogado = true;
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                carregarPainelAdmin();
            } else {
                alert("Senha incorreta!");
            }
        }

        function fazerLogoutAdmin() {
            adminLogado = false;
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
        }

        function carregarPainelAdmin() {
            // Carrega lista de clientes
            const selectClientes = document.getElementById('cliente-licenca');
            const selectAcessoRemoto = document.getElementById('cliente-acesso-remoto');
            
            selectClientes.innerHTML = '<option value="">Selecione um cliente</option>';
            selectAcessoRemoto.innerHTML = '<option value="">Selecione um cliente</option>';
            
            empresas.forEach(empresa => {
                const option = document.createElement('option');
                option.value = empresa.id;
                option.textContent = `${empresa.nome} (${empresa.email})`;
                selectClientes.appendChild(option.cloneNode(true));
                selectAcessoRemoto.appendChild(option.cloneNode(true));
            });
            
            // Configura data padrão para hoje
            document.getElementById('data-inicio-licenca').value = new Date().toISOString().split('T')[0];
            
            // Atualiza preços das licenças
            atualizarExibicaoPrecos();
            
            // Carrega configurações do admin
            document.getElementById('admin-email').value = credenciaisAdmin.email;
            
            // Atualiza tabelas
            atualizarTabelaClientes();
            atualizarTabelaLicencas();
            carregarTicketsSuporte();
            
            // Event listeners para verificação de senha
            document.getElementById('admin-nova-senha').addEventListener('input', verificarForcaSenha);
        }
        
        function openAdminTab(tabId) {
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.admin-container .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(`admin-${tabId}`).classList.add('active');
            document.querySelector(`.admin-container .tab[onclick="openAdminTab('${tabId}')"]`).classList.add('active');
            
            // Carrega dados específicos da aba se necessário
            if (tabId === 'suporte') {
                carregarTicketsSuporte();
            }
        }
        
        function atualizarExibicaoPrecos() {
            document.getElementById('preco-30').textContent = precosLicencas["30"].toFixed(2);
            document.getElementById('preco-90').textContent = precosLicencas["90"].toFixed(2);
            document.getElementById('preco-180').textContent = precosLicencas["180"].toFixed(2);
            document.getElementById('preco-365').textContent = precosLicencas["365"].toFixed(2);
            
            document.getElementById('preco-30-dias').value = precosLicencas["30"];
            document.getElementById('preco-90-dias').value = precosLicencas["90"];
            document.getElementById('preco-180-dias').value = precosLicencas["180"];
            document.getElementById('preco-365-dias').value = precosLicencas["365"];
        }
        
        function salvarPrecosLicencas() {
            precosLicencas["30"] = parseFloat(document.getElementById('preco-30-dias').value);
            precosLicencas["90"] = parseFloat(document.getElementById('preco-90-dias').value);
            precosLicencas["180"] = parseFloat(document.getElementById('preco-180-dias').value);
            precosLicencas["365"] = parseFloat(document.getElementById('preco-365-dias').value);
            
            localStorage.setItem('precosLicencas', JSON.stringify(precosLicencas));
            atualizarExibicaoPrecos();
            closeModal('editar-precos');
            
            alert('Preços das licenças atualizados com sucesso!');
        }
        
        function verificarForcaSenha() {
            const senha = document.getElementById('admin-nova-senha').value;
            const spanForca = document.getElementById('forca-senha');
            
            if (senha.length === 0) {
                spanForca.textContent = "Segurança da senha: ";
                spanForca.className = "";
                return;
            }
            
            // Calcula a força da senha
            let forca = 0;
            
            // Comprimento mínimo
            if (senha.length >= 8) forca++;
            if (senha.length >= 12) forca++;
            
            // Caracteres diversos
            if (/[A-Z]/.test(senha)) forca++;
            if (/[0-9]/.test(senha)) forca++;
            if (/[^A-Za-z0-9]/.test(senha)) forca++;
            
            // Classifica a força
            if (forca <= 2) {
                spanForca.textContent = "Senha fraca";
                spanForca.className = "senha-fraca";
            } else if (forca <= 4) {
                spanForca.textContent = "Senha média";
                spanForca.className = "senha-media";
            } else {
                spanForca.textContent = "Senha forte";
                spanForca.className = "senha-forte";
            }
        }
        
        function atualizarCredenciaisAdmin() {
            const email = document.getElementById('admin-email').value;
            const senhaAtual = document.getElementById('admin-senha-atual').value;
            const novaSenha = document.getElementById('admin-nova-senha').value;
            const confirmarSenha = document.getElementById('admin-confirmar-senha').value;
            
            if (!email) {
                alert('O e-mail é obrigatório');
                return;
            }
            
            // Verifica senha atual se estiver tentando alterar a senha
            if (novaSenha || confirmarSenha) {
                if (senhaAtual !== credenciaisAdmin.senha) {
                    alert('Senha atual incorreta');
                    return;
                }
                
                if (novaSenha !== confirmarSenha) {
                    alert('As novas senhas não coincidem');
                    return;
                }
                
                if (novaSenha.length < 8) {
                    alert('A nova senha deve ter pelo menos 8 caracteres');
                    return;
                }
                
                credenciaisAdmin.senha = novaSenha;
            }
            
            credenciaisAdmin.email = email;
            localStorage.setItem('credenciaisAdmin', JSON.stringify(credenciaisAdmin));
            
            alert('Credenciais atualizadas com sucesso!');
            document.getElementById('admin-senha-atual').value = '';
            document.getElementById('admin-nova-senha').value = '';
            document.getElementById('admin-confirmar-senha').value = '';
            document.getElementById('forca-senha').textContent = "Segurança da senha: ";
            document.getElementById('forca-senha').className = "";
        }
        
        function carregarTicketsSuporte() {
            // Consolida todos os tickets (dos clientes e do sistema)
            const todosTickets = [...ticketsSuporte];
            empresas.forEach(empresa => {
                if (empresa.tickets && empresa.tickets.length > 0) {
                    empresa.tickets.forEach(ticket => {
                        todosTickets.push({
                            ...ticket,
                            empresaId: empresa.id
                        });
                    });
                }
            });
            
            const listaTickets = document.getElementById('lista-tickets');
            listaTickets.innerHTML = '';
            
            // Ordena tickets por urgência e data
            todosTickets.sort((a, b) => {
                if (a.urgente && !b.urgente) return -1;
                if (!a.urgente && b.urgente) return 1;
                return new Date(b.data) - new Date(a.data);
            });
            
            // Contadores para o dashboard
            let abertos = 0;
            let urgentes = 0;
            let resolvidos = 0;
            
            todosTickets.forEach(ticket => {
                const empresa = empresas.find(e => e.id == ticket.empresaId);
                if (!empresa) return;
                
                const ticketDiv = document.createElement('div');
                ticketDiv.className = `ticket ${ticket.urgente ? 'urgente' : ''} ${ticket.status === 'resolvido' ? 'resolvido' : ''}`;
                
                ticketDiv.innerHTML = `
                    <div class="ticket-header">
                        <span class="ticket-cliente">${empresa.nome}</span>
                        <span class="ticket-data">${new Date(ticket.data).toLocaleDateString('pt-BR')}</span>
                    </div>
                    <div>
                        <span class="ticket-status status-${ticket.status}">${
                            ticket.status === 'aberto' ? 'Aberto' : 
                            ticket.status === 'andamento' ? 'Em Andamento' : 'Resolvido'
                        }</span>
                        ${ticket.urgente ? '<span style="margin-left: 10px; color: #e74c3c; font-weight: bold;">URGENTE</span>' : ''}
                    </div>
                    <div class="ticket-mensagem">
                        <p><strong>Assunto:</strong> ${ticket.assunto}</p>
                        <p>${ticket.mensagem}</p>
                        ${ticket.resposta ? `<p style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px;">
                            <strong>Resposta:</strong> ${ticket.resposta}
                        </p>` : ''}
                    </div>
                    <div class="ticket-acoes">
                        <button class="btn-primary btn-sm" onclick="responderTicket(${ticket.id}, ${ticket.empresaId})">Responder</button>
                        ${ticket.status !== 'resolvido' ? 
                            `<button class="btn-success btn-sm" onclick="marcarTicketResolvido(${ticket.id}, ${ticket.empresaId})">Marcar como Resolvido</button>` : ''}
                    </div>
                `;
                
                listaTickets.appendChild(ticketDiv);
                
                // Atualiza contadores
                if (ticket.status === 'resolvido') resolvidos++;
                else {
                    abertos++;
                    if (ticket.urgente) urgentes++;
                }
            });
            
            // Atualiza o dashboard
            document.getElementById('total-tickets-abertos').textContent = abertos;
            document.getElementById('total-tickets-urgentes').textContent = urgentes;
            document.getElementById('total-tickets-resolvidos').textContent = resolvidos;
        }
        
        function responderTicket(ticketId, empresaId) {
            let ticket;
            
            // Primeiro procura nos tickets globais
            ticket = ticketsSuporte.find(t => t.id == ticketId);
            
            // Se não encontrou, procura nos tickets da empresa
            if (!ticket && empresaId) {
                const empresa = empresas.find(e => e.id == empresaId);
                if (empresa && empresa.tickets) {
                    ticket = empresa.tickets.find(t => t.id == ticketId);
                }
            }
            
            if (!ticket) return;
            
            const empresa = empresas.find(e => e.id == (ticket.empresaId || empresaId));
            if (!empresa) return;
            
            document.getElementById('ticket-cliente-nome').textContent = empresa.nome;
            document.getElementById('ticket-assunto').textContent = ticket.assunto;
            document.getElementById('ticket-mensagem-original').textContent = ticket.mensagem;
            document.getElementById('status-ticket').value = ticket.status;
            document.getElementById('resposta-ticket').value = ticket.resposta || '';
            
            // Armazena o ID do ticket e empresa no modal
            document.getElementById('responder-ticket').dataset.ticketId = ticketId;
            document.getElementById('responder-ticket').dataset.empresaId = empresaId || '';
            
            openModal('responder-ticket');
        }
        
        function enviarRespostaTicket() {
            const ticketId = document.getElementById('responder-ticket').dataset.ticketId;
            const empresaId = document.getElementById('responder-ticket').dataset.empresaId;
            const resposta = document.getElementById('resposta-ticket').value;
            const status = document.getElementById('status-ticket').value;
            
            if (!resposta) {
                alert('Digite uma resposta para o ticket');
                return;
            }
            
            let ticket;
            let ticketIndex;
            let isGlobal = false;
            
            // Primeiro procura nos tickets globais
            ticketIndex = ticketsSuporte.findIndex(t => t.id == ticketId);
            if (ticketIndex !== -1) {
                ticket = ticketsSuporte[ticketIndex];
                isGlobal = true;
            } 
            // Se não encontrou, procura nos tickets da empresa
            else if (empresaId) {
                const empresaIndex = empresas.findIndex(e => e.id == empresaId);
                if (empresaIndex !== -1 && empresas[empresaIndex].tickets) {
                    ticketIndex = empresas[empresaIndex].tickets.findIndex(t => t.id == ticketId);
                    if (ticketIndex !== -1) {
                        ticket = empresas[empresaIndex].tickets[ticketIndex];
                    }
                }
            }
            
            if (ticket) {
                ticket.resposta = resposta;
                ticket.status = status;
                ticket.dataResposta = new Date().toISOString();
                
                if (isGlobal) {
                    ticketsSuporte[ticketIndex] = ticket;
                    localStorage.setItem('ticketsSuporte', JSON.stringify(ticketsSuporte));
                } else {
                    const empresaIndex = empresas.findIndex(e => e.id == empresaId);
                    if (empresaIndex !== -1) {
                        empresas[empresaIndex].tickets[ticketIndex] = ticket;
                        localStorage.setItem('empresas', JSON.stringify(empresas));
                    }
                }
                
                closeModal('responder-ticket');
                carregarTicketsSuporte();
                
                alert('Resposta enviada com sucesso!');
            }
        }
        
        function marcarTicketResolvido(ticketId, empresaId) {
            if (!confirm('Deseja marcar este ticket como resolvido?')) {
                return;
            }
            
            let ticket;
            let ticketIndex;
            let isGlobal = false;
            
            // Primeiro procura nos tickets globais
            ticketIndex = ticketsSuporte.findIndex(t => t.id == ticketId);
            if (ticketIndex !== -1) {
                ticket = ticketsSuporte[ticketIndex];
                isGlobal = true;
            } 
            // Se não encontrou, procura nos tickets da empresa
            else if (empresaId) {
                const empresaIndex = empresas.findIndex(e => e.id == empresaId);
                if (empresaIndex !== -1 && empresas[empresaIndex].tickets) {
                    ticketIndex = empresas[empresaIndex].tickets.findIndex(t => t.id == ticketId);
                    if (ticketIndex !== -1) {
                        ticket = empresas[empresaIndex].tickets[ticketIndex];
                    }
                }
            }
            
            if (ticket) {
                ticket.status = 'resolvido';
                ticket.dataResposta = new Date().toISOString();
                
                if (isGlobal) {
                    ticketsSuporte[ticketIndex] = ticket;
                    localStorage.setItem('ticketsSuporte', JSON.stringify(ticketsSuporte));
                } else {
                    const empresaIndex = empresas.findIndex(e => e.id == empresaId);
                    if (empresaIndex !== -1) {
                        empresas[empresaIndex].tickets[ticketIndex] = ticket;
                        localStorage.setItem('empresas', JSON.stringify(empresas));
                    }
                }
                
                carregarTicketsSuporte();
                
                alert('Ticket marcado como resolvido!');
            }
        }
        
        function filtrarTickets() {
            const filtro = document.getElementById('filtro-tickets').value.toLowerCase();
            const tickets = document.querySelectorAll('.ticket');
            
            tickets.forEach(ticket => {
                const texto = ticket.textContent.toLowerCase();
                if (texto.includes(filtro)) {
                    ticket.style.display = '';
                } else {
                    ticket.style.display = 'none';
                }
            });
        }
        
        function limparFiltroTickets() {
            document.getElementById('filtro-tickets').value = '';
            const tickets = document.querySelectorAll('.ticket');
            tickets.forEach(ticket => ticket.style.display = '');
        }
        
        function iniciarAcessoRemoto() {
            const clienteId = document.getElementById('cliente-acesso-remoto').value;
            if (!clienteId) {
                alert('Selecione um cliente para acessar');
                return;
            }
            
            const empresa = empresas.find(e => e.id == clienteId);
            if (!empresa) return;
            
            acessoRemotoAtivo = empresa;
            tempoAcessoRemoto = 0;
            
            // Atualiza UI
            document.getElementById('cliente-acesso-ativo').textContent = `${empresa.nome} (${empresa.email})`;
            document.getElementById('info-acesso-remoto').style.display = 'block';
            document.getElementById('btn-finalizar-acesso').style.display = 'inline-block';
            document.getElementById('cliente-acesso-remoto').disabled = true;
            
            // Inicia contador
            atualizarTempoSessao();
            intervaloAcessoRemoto = setInterval(atualizarTempoSessao, 60000);
            
            alert(`Acesso remoto iniciado para ${empresa.nome}. Você agora pode navegar como este cliente.`);
        }
        
        function finalizarAcessoRemoto() {
            if (!confirm('Deseja realmente finalizar o acesso remoto?')) {
                return;
            }
            
            clearInterval(intervaloAcessoRemoto);
            acessoRemotoAtivo = null;
            
            // Atualiza UI
            document.getElementById('info-acesso-remoto').style.display = 'none';
            document.getElementById('btn-finalizar-acesso').style.display = 'none';
            document.getElementById('cliente-acesso-remoto').disabled = false;
            
            alert('Acesso remoto finalizado com sucesso.');
        }
        
        function atualizarTempoSessao() {
            tempoAcessoRemoto++;
            const horas = Math.floor(tempoAcessoRemoto / 60);
            const minutos = tempoAcessoRemoto % 60;
            document.getElementById('tempo-sessao').textContent = 
                `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
        }

        function gerarLicenca() {
            const clienteId = document.getElementById('cliente-licenca').value;
            const tipo = document.getElementById('tipo-licenca').value;
            const dataInicio = document.getElementById('data-inicio-licenca').value;
            
            if (!clienteId || !tipo || !dataInicio) {
                alert('Preencha todos os campos!');
                return;
            }
            
            const empresa = empresas.find(e => e.id == clienteId);
            if (!empresa) {
                alert('Cliente não encontrado!');
                return;
            }
            
            // Calcula data de fim baseada no tipo
            const dataFim = new Date(dataInicio);
            const dias = parseInt(tipo);
            dataFim.setDate(dataFim.getDate() + dias);
            
            // Obtém valor dos preços configurados
            const valor = precosLicencas[tipo] || 0;
            
            // Cria nova licença
            const novaLicenca = {
                id: Date.now(),
                tipo: tipo,
                dataInicio: dataInicio,
                dataFim: dataFim.toISOString().split('T')[0],
                valor: valor,
                status: "ativo"
            };
            
            // Desativa licenças anteriores
            if (empresa.licencas) {
                empresa.licencas.forEach(l => l.status = "inativo");
            } else {
                empresa.licencas = [];
            }
            
            // Adiciona nova licença
            empresa.licencas.push(novaLicenca);
            empresa.ativo = true;
            
            // Atualiza localStorage
            localStorage.setItem('empresas', JSON.stringify(empresas));
            
            // Atualiza tabelas
            atualizarTabelaClientes();
            atualizarTabelaLicencas();
            
            alert(`Licença gerada com sucesso para ${empresa.nome} até ${novaLicenca.dataFim}`);
        }

        function atualizarTabelaClientes() {
            const tbody = document.querySelector('#tabela-clientes tbody');
            tbody.innerHTML = '';
            
            empresas.forEach(empresa => {
                const licencaAtiva = empresa.licencas?.find(l => l.status === "ativo");
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${empresa.id}</td>
                    <td>${empresa.nome}</td>
                    <td>${empresa.email}</td>
                    <td>${licencaAtiva ? 'Sim' : 'Não'}</td>
                    <td>${licencaAtiva ? licencaAtiva.dataFim : '-'}</td>
                    <td class="${empresa.ativo ? 'status-ativo' : 'status-inativo'}">
                        ${empresa.ativo ? 'Ativo' : 'Inativo'}
                    </td>
                    <td>
                        <button class="btn-primary btn-sm" onclick="editarCliente(${empresa.id})">Editar</button>
                        ${empresa.ativo ? 
                            `<button class="btn-danger btn-sm" onclick="desativarCliente(${empresa.id})">Desativar</button>` : 
                            `<button class="btn-success btn-sm" onclick="ativarCliente(${empresa.id})">Ativar</button>`}
                    </td>
                `;
                
                // Destaca licenças próximas de expirar
                if (licencaAtiva) {
                    const hoje = new Date();
                    const dataFim = new Date(licencaAtiva.dataFim);
                    const diasRestantes = Math.floor((dataFim - hoje) / (1000 * 60 * 60 * 24));
                    
                    if (diasRestantes <= 7 && diasRestantes > 0) {
                        tr.classList.add('licenca-expirando');
                    } else if (dataFim < hoje) {
                        tr.classList.add('licenca-expirada');
                    }
                }
                
                tbody.appendChild(tr);
            });
        }

        function atualizarTabelaLicencas() {
            const tbody = document.querySelector('#tabela-licencas tbody');
            tbody.innerHTML = '';
            
            empresas.forEach(empresa => {
                if (empresa.licencas) {
                    empresa.licencas.forEach(licenca => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${licenca.id}</td>
                            <td>${empresa.nome}</td>
                            <td>${formatarTipoLicenca(licenca.tipo)}</td>
                            <td>${licenca.dataInicio}</td>
                            <td>${licenca.dataFim}</td>
                            <td>R$ ${licenca.valor.toFixed(2)}</td>
                            <td class="${licenca.status === 'ativo' ? 'status-ativo' : 'status-inativo'}">
                                ${licenca.status === 'ativo' ? 'Ativa' : 'Inativa'}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            });
        }

        function formatarTipoLicenca(tipo) {
            switch(tipo) {
                case '30': return '30 dias';
                case '90': return '90 dias';
                case '180': return '180 dias';
                case '365': return '1 ano';
                default: return tipo;
            }
        }

        function filtrarClientes() {
            const filtro = document.getElementById('filtro-clientes').value.toLowerCase();
            const linhas = document.querySelectorAll('#tabela-clientes tbody tr');
            
            linhas.forEach(linha => {
                const textoLinha = linha.textContent.toLowerCase();
                if (textoLinha.includes(filtro)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }

        function filtrarLicencas() {
            const mes = document.getElementById('filtro-mes-licencas').value;
            if (!mes) return;
            
            const [ano, mesNum] = mes.split('-');
            const linhas = document.querySelectorAll('#tabela-licencas tbody tr');
            
            linhas.forEach(linha => {
                const data = linha.cells[3].textContent; // Data de início
                const [dataAno, dataMes] = data.split('-');
                
                if (dataAno === ano && dataMes === mesNum) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        }

        function limparFiltroLicencas() {
            document.getElementById('filtro-mes-licencas').value = '';
            const linhas = document.querySelectorAll('#tabela-licencas tbody tr');
            linhas.forEach(linha => linha.style.display = '');
        }

        function editarCliente(id) {
            const empresa = empresas.find(e => e.id == id);
            if (!empresa) return;
            
            const novoNome = prompt("Novo nome da empresa:", empresa.nome);
            if (novoNome && novoNome !== empresa.nome) {
                empresa.nome = novoNome;
                localStorage.setItem('empresas', JSON.stringify(empresas));
                atualizarTabelaClientes();
            }
        }

        function desativarCliente(id) {
            if (!confirm('Tem certeza que deseja desativar este cliente?')) {
                return;
            }
            
            const empresa = empresas.find(e => e.id == id);
            if (empresa) {
                empresa.ativo = false;
                if (empresa.licencas) {
                    empresa.licencas.forEach(l => l.status = "inativo");
                }
                localStorage.setItem('empresas', JSON.stringify(empresas));
                atualizarTabelaClientes();
                atualizarTabelaLicencas();
            }
        }

        function ativarCliente(id) {
            const empresa = empresas.find(e => e.id == id);
            if (empresa) {
                empresa.ativo = true;
                localStorage.setItem('empresas', JSON.stringify(empresas));
                atualizarTabelaClientes();
            }
        }

        // Funções principais do sistema
        function openTab(evt, tabId) {
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            const tabs = document.getElementsByClassName('tab');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            document.getElementById(tabId).classList.add('active');
            evt.currentTarget.classList.add('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function fecharNotificacao() {
            document.getElementById('notificacao').style.display = 'none';
        }

        function mostrarNotificacao(titulo, mensagem, tipo = '') {
            const notificacao = document.getElementById('notificacao');
            notificacao.className = 'notificacao ' + tipo;
            document.getElementById('notificacao-titulo').textContent = titulo;
            document.getElementById('notificacao-conteudo').innerHTML = mensagem;
            
            const whatsappButton = document.getElementById('whatsapp-button');
            whatsappButton.style.display = 'none';
            
            notificacao.style.display = 'block';
            setTimeout(fecharNotificacao, 10000);
        }

        function verificarPagamentosPendentes() {
            const hoje = new Date();
            const diaAtual = hoje.getDate();
            const proximosPagamentos = [];
            let mensagem = '';
            let mensagemWhatsApp = '🚨 *LEMBRETE DE PAGAMENTOS* 🚨\n\n';
            
            funcionarios.forEach(funcionario => {
                const diaPagamento = funcionario.diaPagamento || 5;
                
                if (diaAtual >= (diaPagamento - 3) && diaAtual <= diaPagamento) {
                    let status, tipo, whatsappStatus;
                    
                    if (diaAtual === diaPagamento) {
                        status = "<strong>HOJE</strong>";
                        tipo = "urgente";
                        whatsappStatus = "⚠️ *PAGAR HOJE* ⚠️";
                    } else {
                        const diasFaltando = diaPagamento - diaAtual;
                        status = `em <strong>${diasFaltando} dia${diasFaltando > 1 ? 's' : ''}</strong>`;
                        tipo = "proximo";
                        whatsappStatus = `⏳ *Próximo em ${diasFaltando} dia${diasFaltando > 1 ? 's' : ''}*`;
                    }
                    
                    proximosPagamentos.push({
                        nome: funcionario.nome,
                        dia: diaPagamento,
                        status: status,
                        tipo: tipo,
                        funcionario: funcionario,
                        whatsappStatus: whatsappStatus
                    });
                }
            });
            
            if (proximosPagamentos.length > 0) {
                mensagem = "<ul style='margin-top: 10px;'>";
                
                const urgentes = proximosPagamentos.filter(p => p.tipo === 'urgente');
                const proximos = proximosPagamentos.filter(p => p.tipo === 'proximo');
                
                if (urgentes.length > 0) {
                    mensagem += "<li style='color: #e74c3c; margin-bottom: 5px;'><strong>PAGAR HOJE:</strong></li>";
                    urgentes.forEach(p => {
                        mensagem += `<li>${p.nome} - Dia ${p.dia} (${p.status})</li>`;
                        mensagemWhatsApp += `${p.whatsappStatus}\n`;
                        mensagemWhatsApp += `👤 *Funcionário:* ${p.funcionario.nome}\n`;
                        mensagemWhatsApp += `💼 *Cargo:* ${p.funcionario.cargo}\n`;
                        mensagemWhatsApp += `💰 *Salário:* R$ ${p.funcionario.salario.toFixed(2)}\n`;
                        mensagemWhatsApp += `📅 *Dia do Pagamento:* ${p.dia}\n`;
                        mensagemWhatsApp += `🏦 *Banco:* ${p.funcionario.banco || 'Não informado'}\n`;
                        mensagemWhatsApp += `📋 *Conta:* ${p.funcionario.conta || 'Não informada'}\n\n`;
                    });
                }
                
                if (proximos.length > 0) {
                    mensagem += "<li style='color: #f39c12; margin: 10px 0 5px;'><strong>PRÓXIMOS:</strong></li>";
                    proximos.forEach(p => {
                        mensagem += `<li>${p.nome} - Dia ${p.dia} (${p.status})</li>`;
                        mensagemWhatsApp += `${p.whatsappStatus}\n`;
                        mensagemWhatsApp += `👤 *Funcionário:* ${p.funcionario.nome}\n`;
                        mensagemWhatsApp += `💼 *Cargo:* ${p.funcionario.cargo}\n`;
                        mensagemWhatsApp += `💰 *Salário:* R$ ${p.funcionario.salario.toFixed(2)}\n`;
                        mensagemWhatsApp += `📅 *Dia do Pagamento:* ${p.dia}\n`;
                        mensagemWhatsApp += `🏦 *Banco:* ${p.funcionario.banco || 'Não informado'}\n`;
                        mensagemWhatsApp += `📋 *Conta:* ${p.funcionario.conta || 'Não informada'}\n\n`;
                    });
                }
                
                mensagem += "</ul>";
                
                const tipoNotificacao = urgentes.length > 0 ? 'urgente' : 'proximo';
                const titulo = urgentes.length > 0 ? '⚠️ Pagamentos para HOJE' : '📅 Pagamentos próximos';
                
                mostrarNotificacao(titulo, mensagem, tipoNotificacao);
                
                const whatsappButton = document.getElementById('whatsapp-button');
                whatsappButton.style.display = 'block';
                whatsappButton.onclick = function() {
                    enviarWhatsAppNotificacao(mensagemWhatsApp);
                };
            }
            
            // Verificar pagamentos pendentes de profissionais diaristas
            const pagamentosPendentesDiaristas = pagamentosDiaristas.filter(p => !p.integradoFolha);
            if (pagamentosPendentesDiaristas.length > 0) {
                let msgDiaristas = "<p style='margin-top: 15px; color: #e74c3c;'><strong>PAGAMENTOS A PROFISSIONAIS PENDENTES:</strong></p><ul>";
                
                pagamentosPendentesDiaristas.forEach(p => {
                    msgDiaristas += `<li>${p.nome} - R$ ${p.valor.toFixed(2)} (${new Date(p.data).toLocaleDateString('pt-BR')})</li>`;
                });
                
                msgDiaristas += "</ul>";
                
                document.getElementById('notificacao-conteudo').innerHTML += msgDiaristas;
            }

            // Verificar despesas pendentes
            const despesasPendentes = despesas.filter(d => d.status === 'Pendente');
            if (despesasPendentes.length > 0) {
                let msgDespesas = "<p style='margin-top: 15px; color: #e74c3c;'><strong>DESPESAS PENDENTES:</strong></p><ul>";
                
                despesasPendentes.forEach(d => {
                    msgDespesas += `<li>${d.descricao} - R$ ${d.valor.toFixed(2)} (${new Date(d.data).toLocaleDateString('pt-BR')})</li>`;
                });
                
                msgDespesas += "</ul>";
                
                document.getElementById('notificacao-conteudo').innerHTML += msgDespesas;
            }
        }

        function enviarWhatsAppNotificacao(mensagem) {
            const numeroWhatsApp = "75992946310";
            const texto = encodeURIComponent(mensagem);
            const urlWhatsApp = `https://wa.me/${numeroWhatsApp}?text=${texto}`;
            window.open(urlWhatsApp, '_blank');
            fecharNotificacao();
        }

        function calcularPagamento() {
            const funcionarioId = document.getElementById('funcionario-pagamento').value;
            
            if (!funcionarioId) {
                alert('Selecione um funcionário');
                return;
            }
            
            const funcionario = funcionarios.find(f => f.id == funcionarioId);
            const horasExtras = parseFloat(document.getElementById('horas-extras').value) || 0;
            const descontos = parseFloat(document.getElementById('descontos').value) || 0;
            const bonus = parseFloat(document.getElementById('bonus').value) || 0;
            
            const valorHoraExtra = (funcionario.salario / 220) * 1.5;
            const totalHorasExtras = horasExtras * valorHoraExtra;
            const total = funcionario.salario + totalHorasExtras + bonus - descontos;
            
            document.getElementById('total-pagamento').value = total.toFixed(2);
        }

        function registrarPagamento() {
            const funcionarioId = document.getElementById('funcionario-pagamento').value;
            const dia = document.getElementById('dia-pagamento').value.padStart(2, '0');
            const mes = document.getElementById('mes-pagamento').value;
            const ano = document.getElementById('ano-pagamento').value;
            const total = document.getElementById('total-pagamento').value;
            
            if (!funcionarioId || !dia || !mes || !ano || !total) {
                alert('Preencha todos os campos e calcule o pagamento antes de registrar');
                return;
            }
            
            const dataPagamento = new Date(`${ano}-${mes}-${dia}`);
            if (isNaN(dataPagamento.getTime())) {
                alert('Data inválida! Verifique o dia, mês e ano.');
                return;
            }

            const funcionario = funcionarios.find(f => f.id == funcionarioId);
            const periodo = `${dia}/${mes}/${ano}`;
            
            const novoPagamento = {
                id: pagamentos.length + 1,
                funcionarioId: funcionarioId,
                funcionarioNome: funcionario.nome,
                tipo: "Funcionário",
                periodo: periodo,
                salarioBase: funcionario.salario,
                horasExtras: parseFloat(document.getElementById('horas-extras').value) || 0,
                descontos: parseFloat(document.getElementById('descontos').value) || 0,
                bonus: parseFloat(document.getElementById('bonus').value) || 0,
                total: parseFloat(total),
                dataPagamento: new Date().toISOString().split('T')[0],
                status: "Pendente"
            };
            
            pagamentos.push(novoPagamento);
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.pagamentos = pagamentos;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            atualizarTabelas();
            
            document.getElementById('funcionario-pagamento').value = '';
            document.getElementById('dia-pagamento').value = '';
            document.getElementById('mes-pagamento').value = '';
            document.getElementById('ano-pagamento').value = '';
            document.getElementById('salario-base').value = '';
            document.getElementById('horas-extras').value = '0';
            document.getElementById('descontos').value = '0';
            document.getElementById('bonus').value = '0';
            document.getElementById('total-pagamento').value = '';
            
            alert('Pagamento registrado com sucesso!');
        }

        function marcarComoPago(pagamentoId) {
            if (!confirm('Deseja realmente marcar este pagamento como realizado?')) {
                return;
            }
            
            const pagamento = pagamentos.find(p => p.id == pagamentoId);
            if (pagamento) {
                pagamento.status = "Pago";
                pagamento.dataPagamento = new Date().toISOString().split('T')[0];
                
                // Atualiza os dados da empresa logada
                if (empresaLogada) {
                    empresaLogada.pagamentos = pagamentos;
                    localStorage.setItem('empresas', JSON.stringify(empresas));
                }
                
                atualizarTabelas();
                mostrarNotificacao('Pagamento Confirmado', `O pagamento para ${pagamento.funcionarioNome} foi marcado como realizado.`, 'sucesso');
            }
        }

        function editarFuncionario(id) {
            const funcionario = funcionarios.find(f => f.id == id);
            
            if (!funcionario) {
                alert('Funcionário não encontrado!');
                return;
            }
            
            document.getElementById('nome-funcionario').value = funcionario.nome;
            document.getElementById('cpf-funcionario').value = funcionario.cpf;
            document.getElementById('cargo-funcionario').value = funcionario.cargo;
            document.getElementById('salario-funcionario').value = funcionario.salario;
            document.getElementById('dia-pagamento-func').value = funcionario.diaPagamento || 5;
            document.getElementById('data-admissao').value = funcionario.dataAdmissao;
            document.getElementById('banco-funcionario').value = funcionario.banco || '';
            document.getElementById('conta-funcionario').value = funcionario.conta || '';
            
            let idInput = document.getElementById('funcionario-id');
            if (!idInput) {
                idInput = document.createElement('input');
                idInput.type = 'hidden';
                idInput.id = 'funcionario-id';
                document.querySelector('#novo-funcionario .modal-content').appendChild(idInput);
            }
            idInput.value = id;
            
            document.querySelector('#novo-funcionario h2').textContent = 'Editar Funcionário';
            document.querySelector('#novo-funcionario button').textContent = 'Salvar Alterações';
            
            openModal('novo-funcionario');
        }

        function excluirFuncionario(id) {
            if (!confirm('Tem certeza que deseja excluir este funcionário?')) {
                return;
            }
            
            funcionarios = funcionarios.filter(f => f.id != id);
            
            // Remove os pagamentos associados a este funcionário
            pagamentos = pagamentos.filter(p => p.funcionarioId != id);
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.funcionarios = funcionarios;
                empresaLogada.pagamentos = pagamentos;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            atualizarTabelas();
            alert('Funcionário excluído com sucesso!');
        }

        function salvarFuncionario() {
            const id = document.getElementById('funcionario-id')?.value;
            const nome = document.getElementById('nome-funcionario').value;
            const cpf = document.getElementById('cpf-funcionario').value;
            const cargo = document.getElementById('cargo-funcionario').value;
            const salario = parseFloat(document.getElementById('salario-funcionario').value);
            const diaPagamento = parseInt(document.getElementById('dia-pagamento-func').value) || 5;
            const dataAdmissao = document.getElementById('data-admissao').value;
            const banco = document.getElementById('banco-funcionario').value;
            const conta = document.getElementById('conta-funcionario').value;
            
            if (!nome || !cpf || !cargo || !salario || !dataAdmissao) {
                alert('Preencha todos os campos obrigatórios');
                return;
            }
            
            if (id) {
                // Edição de funcionário existente
                const index = funcionarios.findIndex(f => f.id == id);
                if (index !== -1) {
                    funcionarios[index] = {
                        ...funcionarios[index],
                        nome,
                        cpf,
                        cargo,
                        salario,
                        diaPagamento,
                        dataAdmissao,
                        banco,
                        conta
                    };
                }
            } else {
                // Novo funcionário
                const novoFuncionario = {
                    id: funcionarios.length > 0 ? Math.max(...funcionarios.map(f => f.id)) + 1 : 1,
                    nome,
                    cpf,
                    cargo,
                    salario,
                    diaPagamento,
                    dataAdmissao,
                    banco,
                    conta
                };
                funcionarios.push(novoFuncionario);
            }
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.funcionarios = funcionarios;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            atualizarTabelas();
            closeModal('novo-funcionario');
            
            // Limpa o formulário
            document.getElementById('nome-funcionario').value = '';
            document.getElementById('cpf-funcionario').value = '';
            document.getElementById('cargo-funcionario').value = '';
            document.getElementById('salario-funcionario').value = '';
            document.getElementById('dia-pagamento-func').value = '5';
            document.getElementById('data-admissao').value = '';
            document.getElementById('banco-funcionario').value = '';
            document.getElementById('conta-funcionario').value = '';
            
            const idInput = document.getElementById('funcionario-id');
            if (idInput) idInput.remove();
            
            document.querySelector('#novo-funcionario h2').textContent = 'Novo Funcionário';
            document.querySelector('#novo-funcionario button').textContent = 'Salvar Funcionário';
            
            alert(`Funcionário ${id ? 'atualizado' : 'cadastrado'} com sucesso!`);
        }

        function registrarPagamentoDiarista() {
            const nome = document.getElementById('diarista-nome-pagamento').value;
            const data = document.getElementById('diarista-data-pagamento').value;
            const valor = parseFloat(document.getElementById('diarista-valor-pagamento').value);
            const descricao = document.getElementById('diarista-descricao').value;
            
            if (!nome || !data || !valor) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            const novoPagamento = {
                id: Date.now(),
                nome,
                data,
                valor,
                descricao,
                integradoFolha: false
            };
            
            pagamentosDiaristas.push(novoPagamento);
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.pagamentosDiaristas = pagamentosDiaristas;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            atualizarTabelaDiaristas();
            atualizarDashboard();
            
            // Limpa o formulário
            document.getElementById('diarista-nome-pagamento').value = '';
            document.getElementById('diarista-data-pagamento').value = '';
            document.getElementById('diarista-valor-pagamento').value = '';
            document.getElementById('diarista-descricao').value = '';
            
            alert('Pagamento registrado com sucesso!');
        }

        function integrarNaFolhaDiarista(id) {
            if (!confirm('Deseja integrar este pagamento na folha de pagamento?')) {
                return;
            }
            
            const pagamento = pagamentosDiaristas.find(p => p.id == id);
            if (pagamento) {
                const novoPagamentoFolha = {
                    id: pagamentos.length + 1,
                    funcionarioId: null,
                    funcionarioNome: `Profissional: ${pagamento.nome}`,
                    tipo: "Profissional Diarista",
                    periodo: new Date(pagamento.data).toLocaleDateString('pt-BR'),
                    salarioBase: 0,
                    horasExtras: 0,
                    descontos: 0,
                    bonus: 0,
                    total: pagamento.valor,
                    dataPagamento: new Date().toISOString().split('T')[0],
                    status: "Pago",
                    observacao: pagamento.descricao || "Pagamento a profissional diarista"
                };
                
                pagamentos.push(novoPagamentoFolha);
                pagamento.integradoFolha = true;
                
                // Atualiza os dados da empresa logada
                if (empresaLogada) {
                    empresaLogada.pagamentos = pagamentos;
                    empresaLogada.pagamentosDiaristas = pagamentosDiaristas;
                    localStorage.setItem('empresas', JSON.stringify(empresas));
                }
                
                atualizarTabelaDiaristas();
                atualizarTabelas();
                
                alert('Pagamento integrado na folha com sucesso!');
            }
        }

        function atualizarTabelaDiaristas() {
            const tbody = document.querySelector('#tabela-pagamentos-diaristas tbody');
            tbody.innerHTML = '';
            
            pagamentosDiaristas.sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(pagamento => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(pagamento.data).toLocaleDateString('pt-BR')}</td>
                    <td>${pagamento.nome}</td>
                    <td>R$ ${pagamento.valor.toFixed(2)}</td>
                    <td>${pagamento.descricao || '-'}</td>
                    <td>${pagamento.integradoFolha ? '✅ Sim' : '❌ Não'}</td>
                    <td>
                        ${!pagamento.integradoFolha ? 
                            `<button class="btn-primary btn-sm" onclick="integrarNaFolhaDiarista(${pagamento.id})">Integrar</button>` : ''}
                        <button class="btn-danger btn-sm" onclick="excluirPagamentoDiarista(${pagamento.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function excluirPagamentoDiarista(id) {
            if (!confirm('Tem certeza que deseja excluir este pagamento?')) {
                return;
            }
            
            pagamentosDiaristas = pagamentosDiaristas.filter(p => p.id != id);
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.pagamentosDiaristas = pagamentosDiaristas;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            atualizarTabelaDiaristas();
            atualizarDashboard();
        }

        function filtrarDiaristasPorMes() {
            const mesAno = document.getElementById('diaristas-mes-filtro').value;
            if (!mesAno) return;
            
            const [ano, mes] = mesAno.split('-');
            const pagamentosFiltrados = pagamentosDiaristas.filter(p => {
                const data = new Date(p.data);
                return data.getFullYear() == ano && (data.getMonth() + 1) == mes;
            });
            
            const tbody = document.querySelector('#tabela-pagamentos-diaristas tbody');
            tbody.innerHTML = '';
            
            pagamentosFiltrados.forEach(pagamento => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${new Date(pagamento.data).toLocaleDateString('pt-BR')}</td>
                    <td>${pagamento.nome}</td>
                    <td>R$ ${pagamento.valor.toFixed(2)}</td>
                    <td>${pagamento.descricao || '-'}</td>
                    <td>${pagamento.integradoFolha ? '✅ Sim' : '❌ Não'}</td>
                    <td>
                        ${!pagamento.integradoFolha ? 
                            `<button class="btn-primary btn-sm" onclick="integrarNaFolhaDiarista(${pagamento.id})">Integrar</button>` : ''}
                        <button class="btn-danger btn-sm" onclick="excluirPagamentoDiarista(${pagamento.id})">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function limparFiltroDiaristas() {
            document.getElementById('diaristas-mes-filtro').value = '';
            atualizarTabelaDiaristas();
        }

        function atualizarDashboard() {
            // Total gasto com profissionais diaristas no mês atual
            const hoje = new Date();
            const mesAtual = hoje.getMonth() + 1;
            const anoAtual = hoje.getFullYear();
            
            const totalDiaristasMes = pagamentosDiaristas
                .filter(p => {
                    const data = new Date(p.data);
                    return data.getMonth() + 1 === mesAtual && data.getFullYear() === anoAtual;
                })
                .reduce((sum, p) => sum + p.valor, 0);
            
            document.getElementById('total-diaristas').textContent = `R$ ${totalDiaristasMes.toFixed(2)}`;

            // Total de despesas no mês atual
            const totalDespesasMes = despesas
                .filter(d => {
                    const data = new Date(d.data);
                    return data.getMonth() + 1 === mesAtual && data.getFullYear() === anoAtual && d.status !== 'Cancelado';
                })
                .reduce((sum, d) => sum + d.valor, 0);
            
            document.getElementById('total-despesas-dashboard').textContent = `R$ ${totalDespesasMes.toFixed(2)}`;
        }

        // Funções para controle de despesas
        function carregarDespesas() {
            const tbody = document.querySelector('#tabela-despesas tbody');
            tbody.innerHTML = '';
            
            let total = 0;
            
            despesas.forEach(despesa => {
                total += despesa.status !== 'Cancelado' ? despesa.valor : 0;
                
                const tr = document.createElement('tr');
                tr.className = `categoria-${despesa.categoria.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${new Date(despesa.data).toLocaleDateString('pt-BR')}</td>
                    <td>${despesa.descricao}</td>
                    <td><span class="badge-categoria badge-${despesa.categoria.toLowerCase()}">${despesa.categoria}</span></td>
                    <td>R$ ${despesa.valor.toFixed(2)}</td>
                    <td>${despesa.vencimento ? new Date(despesa.vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                    <td class="status-${despesa.status.toLowerCase()}">${despesa.status}</td>
                    <td>
                        <button class="btn-primary btn-sm" onclick="editarDespesaModal(${despesa.id})">Editar</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('total-despesas').textContent = total.toFixed(2);

            // Atualiza últimas despesas no dashboard
            const tbodyUltimasDespesas = document.querySelector('#ultimas-despesas tbody');
            tbodyUltimasDespesas.innerHTML = '';
            
            const ultimasDespesas = [...despesas]
                .sort((a, b) => new Date(b.data) - new Date(a.data))
                .slice(0, 5);
            
            ultimasDespesas.forEach(despesa => {
                const tr = document.createElement('tr');
                tr.className = `categoria-${despesa.categoria.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${new Date(despesa.data).toLocaleDateString('pt-BR')}</td>
                    <td>${despesa.descricao}</td>
                    <td>${despesa.categoria}</td>
                    <td>R$ ${despesa.valor.toFixed(2)}</td>
                    <td class="status-${despesa.status.toLowerCase()}">${despesa.status}</td>
                `;
                tbodyUltimasDespesas.appendChild(tr);
            });
        }
        
        function filtrarDespesas() {
            const categoria = document.getElementById('filtro-categoria').value;
            const status = document.getElementById('filtro-status').value;
            const mes = document.getElementById('filtro-mes-despesas').value;
            
            let despesasFiltradas = [...despesas];
            
            if (categoria) {
                despesasFiltradas = despesasFiltradas.filter(d => d.categoria === categoria);
            }
            
            if (status) {
                despesasFiltradas = despesasFiltradas.filter(d => d.status === status);
            }
            
            if (mes) {
                const [ano, mesNum] = mes.split('-');
                despesasFiltradas = despesasFiltradas.filter(d => {
                    const data = new Date(d.data);
                    return data.getFullYear() == ano && (data.getMonth() + 1) == mesNum;
                });
            }
            
            const tbody = document.querySelector('#tabela-despesas tbody');
            tbody.innerHTML = '';
            
            let total = 0;
            
            despesasFiltradas.forEach(despesa => {
                total += despesa.status !== 'Cancelado' ? despesa.valor : 0;
                
                const tr = document.createElement('tr');
                tr.className = `categoria-${despesa.categoria.toLowerCase()}`;
                
                tr.innerHTML = `
                    <td>${new Date(despesa.data).toLocaleDateString('pt-BR')}</td>
                    <td>${despesa.descricao}</td>
                    <td><span class="badge-categoria badge-${despesa.categoria.toLowerCase()}">${despesa.categoria}</span></td>
                    <td>R$ ${despesa.valor.toFixed(2)}</td>
                    <td>${despesa.vencimento ? new Date(despesa.vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                    <td class="status-${despesa.status.toLowerCase()}">${despesa.status}</td>
                    <td>
                        <button class="btn-primary btn-sm" onclick="editarDespesaModal(${despesa.id})">Editar</button>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            document.getElementById('total-despesas').textContent = total.toFixed(2);
        }
        
        function limparFiltrosDespesas() {
            document.getElementById('filtro-categoria').value = '';
            document.getElementById('filtro-status').value = '';
            document.getElementById('filtro-mes-despesas').value = '';
            carregarDespesas();
        }
        
        function salvarDespesa() {
            const novaDespesa = {
                id: despesas.length > 0 ? Math.max(...despesas.map(d => d.id)) + 1 : 1,
                descricao: document.getElementById('despesa-descricao').value,
                categoria: document.getElementById('despesa-categoria').value,
                valor: parseFloat(document.getElementById('despesa-valor').value),
                data: document.getElementById('despesa-data').value,
                vencimento: document.getElementById('despesa-vencimento').value || null,
                status: document.getElementById('despesa-status').value,
                observacoes: document.getElementById('despesa-observacoes').value
            };
            
            if (!novaDespesa.descricao || !novaDespesa.valor || !novaDespesa.data) {
                alert('Preencha todos os campos obrigatórios!');
                return;
            }
            
            despesas.push(novaDespesa);
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.despesas = despesas;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            carregarDespesas();
            closeModal('nova-despesa');
            
            // Limpa o formulário
            document.getElementById('nova-despesa').querySelector('form').reset();
            
            alert('Despesa cadastrada com sucesso!');
        }
        
        function editarDespesaModal(id) {
            const despesa = despesas.find(d => d.id == id);
            if (!despesa) return;
            
            document.getElementById('editar-despesa-id').value = despesa.id;
            document.getElementById('editar-despesa-descricao').value = despesa.descricao;
            document.getElementById('editar-despesa-categoria').value = despesa.categoria;
            document.getElementById('editar-despesa-valor').value = despesa.valor;
            document.getElementById('editar-despesa-data').value = despesa.data;
            document.getElementById('editar-despesa-vencimento').value = despesa.vencimento || '';
            document.getElementById('editar-despesa-status').value = despesa.status;
            document.getElementById('editar-despesa-observacoes').value = despesa.observacoes || '';
            
            openModal('editar-despesa');
        }
        
        function atualizarDespesa() {
            const id = parseInt(document.getElementById('editar-despesa-id').value);
            const index = despesas.findIndex(d => d.id == id);
            
            if (index === -1) return;
            
            despesas[index] = {
                ...despesas[index],
                descricao: document.getElementById('editar-despesa-descricao').value,
                categoria: document.getElementById('editar-despesa-categoria').value,
                valor: parseFloat(document.getElementById('editar-despesa-valor').value),
                data: document.getElementById('editar-despesa-data').value,
                vencimento: document.getElementById('editar-despesa-vencimento').value || null,
                status: document.getElementById('editar-despesa-status').value,
                observacoes: document.getElementById('editar-despesa-observacoes').value
            };
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.despesas = despesas;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            carregarDespesas();
            closeModal('editar-despesa');
            
            alert('Despesa atualizada com sucesso!');
        }
        
        function excluirDespesa() {
            if (!confirm('Tem certeza que deseja excluir esta despesa?')) {
                return;
            }
            
            const id = parseInt(document.getElementById('editar-despesa-id').value);
            despesas = despesas.filter(d => d.id != id);
            
            // Atualiza os dados da empresa logada
            if (empresaLogada) {
                empresaLogada.despesas = despesas;
                localStorage.setItem('empresas', JSON.stringify(empresas));
            }
            
            carregarDespesas();
            closeModal('editar-despesa');
            
            alert('Despesa excluída com sucesso!');
        }

        function gerarRelatorio() {
            const mesInicio = document.getElementById('mes-inicio').value;
            const mesFim = document.getElementById('mes-fim').value;
            
            if (!mesInicio || !mesFim) {
                alert('Selecione o período para gerar o relatório');
                return;
            }
            
            // Filtra pagamentos de funcionários
            const pagamentosFiltrados = pagamentos.filter(p => {
                const [dia, mes, ano] = p.periodo.split('/');
                const dataPagamento = `${ano}-${mes}-${dia}`;
                return dataPagamento >= `${mesInicio}-01` && dataPagamento <= `${mesFim}-31`;
            });
            
            // Filtra pagamentos de profissionais diaristas integrados
            const diaristasFiltradas = pagamentosDiaristas.filter(p => {
                return p.data >= `${mesInicio}-01` && p.data <= `${mesFim}-31` && p.integradoFolha;
            });
            
            // Filtra despesas no período
            const despesasFiltradas = despesas.filter(d => {
                return d.data >= `${mesInicio}-01` && d.data <= `${mesFim}-31` && d.status !== 'Cancelado';
            });
            
            const totalFuncionarios = pagamentosFiltrados.reduce((sum, p) => sum + p.total, 0);
            const totalDiaristas = diaristasFiltradas.reduce((sum, p) => sum + p.valor, 0);
            const totalDespesas = despesasFiltradas.reduce((sum, d) => sum + d.valor, 0);
            const totalGeral = totalFuncionarios + totalDiaristas;
            const saldo = totalGeral - totalDespesas;
            
            let html = `
                <h3>Relatório Financeiro (${mesInicio} a ${mesFim})</h3>
                
                <h4>Receitas</h4>
                <p><strong>Total de pagamentos a funcionários:</strong> ${pagamentosFiltrados.length}</p>
                <p><strong>Valor total funcionários:</strong> R$ ${totalFuncionarios.toFixed(2)}</p>
                <p><strong>Total de pagamentos a profissionais diaristas:</strong> ${diaristasFiltradas.length}</p>
                <p><strong>Valor total profissionais diaristas:</strong> R$ ${totalDiaristas.toFixed(2)}</p>
                <p><strong>Total recebido:</strong> R$ ${totalGeral.toFixed(2)}</p>
                
                <h4>Despesas</h4>
                <p><strong>Total de despesas:</strong> ${despesasFiltradas.length}</p>
                <p><strong>Valor total despesas:</strong> R$ ${totalDespesas.toFixed(2)}</p>
                
                <h4>Resumo Financeiro</h4>
                <p><strong>Saldo:</strong> R$ ${saldo.toFixed(2)}</p>
                
                <h4 style="margin-top: 20px;">Pagamentos a Funcionários</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Funcionário</th>
                            <th>Período</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            pagamentosFiltrados.forEach(p => {
                html += `
                    <tr>
                        <td>${p.funcionarioNome}</td>
                        <td>${p.periodo}</td>
                        <td>R$ ${p.total.toFixed(2)}</td>
                        <td class="${p.status === 'Pago' ? 'status-pago' : 'status-pendente'}">${p.status}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h4 style="margin-top: 20px;">Pagamentos a Profissionais Diaristas</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Profissional</th>
                            <th>Data</th>
                            <th>Valor</th>
                            <th>Descrição</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            diaristasFiltradas.forEach(p => {
                html += `
                    <tr>
                        <td>${p.nome}</td>
                        <td>${new Date(p.data).toLocaleDateString('pt-BR')}</td>
                        <td>R$ ${p.valor.toFixed(2)}</td>
                        <td>${p.descricao || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                
                <h4 style="margin-top: 20px;">Despesas</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Data</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            despesasFiltradas.forEach(d => {
                html += `
                    <tr class="categoria-${d.categoria.toLowerCase()}">
                        <td>${d.descricao}</td>
                        <td>${d.categoria}</td>
                        <td>R$ ${d.valor.toFixed(2)}</td>
                        <td>${new Date(d.data).toLocaleDateString('pt-BR')}</td>
                        <td class="status-${d.status.toLowerCase()}">${d.status}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('resultado-relatorio').innerHTML = html;
        }

        function atualizarTabelas() {
            // Tabela de funcionários
            const tbodyFuncionarios = document.querySelector('#tabela-funcionarios tbody');
            tbodyFuncionarios.innerHTML = '';
            
            funcionarios.forEach(funcionario => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${funcionario.id}</td>
                    <td>${funcionario.nome}</td>
                    <td>${funcionario.cargo}</td>
                    <td>R$ ${funcionario.salario.toFixed(2)}</td>
                    <td>Dia ${funcionario.diaPagamento || 5}</td>
                    <td>${new Date(funcionario.dataAdmissao).toLocaleDateString('pt-BR')}</td>
                    <td>
                        <button class="btn-primary btn-sm" onclick="editarFuncionario(${funcionario.id})">Editar</button>
                        <button class="btn-danger btn-sm" onclick="excluirFuncionario(${funcionario.id})">Excluir</button>
                    </td>
                `;
                tbodyFuncionarios.appendChild(tr);
            });
            
            // Select de funcionários
            const selectFuncionarios = document.getElementById('funcionario-pagamento');
            selectFuncionarios.innerHTML = '<option value="">Selecione um funcionário</option>';
            
            funcionarios.forEach(funcionario => {
                const option = document.createElement('option');
                option.value = funcionario.id;
                option.textContent = `${funcionario.nome} (${funcionario.cargo})`;
                selectFuncionarios.appendChild(option);
            });
            
            // Histórico de pagamentos
            const tbodyPagamentos = document.querySelector('#historico-pagamentos tbody');
            tbodyPagamentos.innerHTML = '';
            
            pagamentos.forEach(pagamento => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pagamento.id}</td>
                    <td>${pagamento.funcionarioNome}</td>
                    <td>${pagamento.tipo}</td>
                    <td>${pagamento.periodo}</td>
                    <td>R$ ${pagamento.total.toFixed(2)}</td>
                    <td>${new Date(pagamento.dataPagamento).toLocaleDateString('pt-BR')}</td>
                    <td class="${pagamento.status === 'Pago' ? 'status-pago' : 'status-pendente'}">
                        ${pagamento.status}
                    </td>
                    <td>
                        ${pagamento.status === 'Pendente' ? 
                            `<button class="btn-success btn-sm" onclick="marcarComoPago(${pagamento.id})">Confirmar Pagamento</button>` : 
                            '---'}
                    </td>
                `;
                tbodyPagamentos.appendChild(tr);
            });
            
            // Dashboard
            document.getElementById('total-funcionarios').textContent = funcionarios.length;
            
            const totalFolha = funcionarios.reduce((sum, f) => sum + f.salario, 0);
            document.getElementById('total-folha').textContent = `R$ ${totalFolha.toFixed(2)}`;
            
            const diasPagamento = funcionarios.map(f => f.diaPagamento || 5);
            const menorDia = diasPagamento.length > 0 ? Math.min(...diasPagamento) : null;
            
            if (menorDia) {
                const hoje = new Date();
                let proximoPagamento = new Date(hoje.getFullYear(), hoje.getMonth(), menorDia);
                
                if (hoje.getDate() > menorDia) {
                    proximoPagamento = new Date(hoje.getFullYear(), hoje.getMonth() + 1, menorDia);
                }
                
                document.getElementById('proximo-pagamento').textContent = proximoPagamento.toLocaleDateString('pt-BR');
            } else {
                document.getElementById('proximo-pagamento').textContent = '--/--/----';
            }
            
            // Atualiza dashboard diaristas e despesas
            atualizarDashboard();
            
            // Últimos pagamentos
            const tbodyUltimosPagamentos = document.querySelector('#ultimos-pagamentos tbody');
            tbodyUltimosPagamentos.innerHTML = '';
            
            const ultimosPagamentos = [...pagamentos]
                .sort((a, b) => new Date(b.dataPagamento) - new Date(a.dataPagamento))
                .slice(0, 5);
            
            ultimosPagamentos.forEach(pagamento => {
                const funcionario = funcionarios.find(f => f.id == pagamento.funcionarioId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${pagamento.funcionarioNome}</td>
                    <td>${pagamento.tipo}</td>
                    <td>R$ ${pagamento.total.toFixed(2)}</td>
                    <td>${pagamento.periodo}</td>
                    <td class="${pagamento.status === 'Pago' ? 'status-pago' : 'status-pendente'}">
                        ${pagamento.status}
                    </td>
                `;
                tbodyUltimosPagamentos.appendChild(tr);
            });
        }

        // Event listeners
        document.getElementById('funcionario-pagamento').addEventListener('change', function() {
            const funcionarioId = this.value;
            if (funcionarioId) {
                const funcionario = funcionarios.find(f => f.id == funcionarioId);
                document.getElementById('salario-base').value = funcionario.salario.toFixed(2);
            } else {
                document.getElementById('salario-base').value = '';
            }
        });

        // Inicialização
        window.onload = function() {
            // Verifica se é um acesso ao painel admin
            if (window.location.href.includes('?admin')) {
                acessarPainelAdmin();
                return;
            }
            
            // Verifica sessão normal
            const sessao = JSON.parse(localStorage.getItem('sessao'));
            if (sessao) {
                const empresa = empresas.find(e => e.id === sessao.empresaId);
                if (empresa && empresa.ativo) {
                    // Verifica licença
                    const licencaAtiva = empresa.licencas?.find(l => l.status === "ativo");
                    if (licencaAtiva) {
                        const hoje = new Date();
                        const dataFim = new Date(licencaAtiva.dataFim);
                        
                        if (dataFim >= hoje) {
                            // Verifica se a sessão ainda está ativa
                            const sessaoAtiva = sessoesAtivas.find(s => s.id === sessao.sessaoId && s.ativa);
                            if (sessaoAtiva) {
                                empresaLogada = empresa;
                                iniciarSessao(empresa);
                                return;
                            } else {
                                localStorage.removeItem('sessao');
                                alert('Sua sessão foi encerrada em outro dispositivo.');
                            }
                        } else {
                            localStorage.removeItem('sessao');
                            alert('Sua licença expirou. Entre em contato com o suporte.');
                        }
                    }
                }
            }
            
            // Se não houver sessão válida, mostra a página de login
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            
            // Configura a verificação periódica de pagamentos pendentes
            setInterval(verificarPagamentosPendentes, 86400000); // Verifica a cada 24 horas
            
            // Verifica sessão a cada 5 minutos
            setInterval(() => {
                if (empresaLogada && !verificarSessoesAtivas()) {
                    fazerLogout();
                }
            }, 300000);
        };
    </script>

<div id="notificacao" style="display:none; background:#ffe4b5; padding:10px; margin:10px 0;">
  <div id="notificacao-conteudo"></div>
  <button id="whatsapp-button" style="margin-top:10px; display:none;">Notificar por WhatsApp</button>
</div>

</body>

<script>
function verificarPagamentosPendentes() {
    const hoje = new Date();
    const diaHoje = hoje.getDate();

    if (!window.funcionarios || !window.empresaLogada) return;

    const funcionariosHoje = window.funcionarios.filter(f => parseInt(f.diaPagamento) === diaHoje);

    if (funcionariosHoje.length > 0 && window.empresaLogada?.telefone) {
        const mensagem = funcionariosHoje.map(f => `📌 Hoje é dia de pagar: ${f.nome} (R$ ${f.salario.toFixed(2)})`).join('%0A');
        const numero = window.empresaLogada.telefone.replace(/[^0-9]/g, '');
        const url = `https://wa.me/55${numero}?text=${mensagem}`;

        document.getElementById('notificacao-conteudo').innerHTML = funcionariosHoje.map(f => `<p>📢 Pagamento de <strong>${f.nome}</strong> (R$ ${f.salario.toFixed(2)}) hoje!</p>`).join('');
        document.getElementById('whatsapp-button').onclick = () => window.open(url, '_blank');
        document.getElementById('whatsapp-button').style.display = 'inline-block';
        document.getElementById('notificacao').style.display = 'block';
    } else {
        document.getElementById('notificacao').style.display = 'none';
    }
}
</script>

</html>